<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Produk - AI UMKM</title>
    <meta name="description" content="Kelola data produk UMKM untuk promosi AI">
    
    <link rel="icon" type="image/png" href="assets/icons/icon-primary.png">
    
    <link rel="stylesheet" href="src/css/style.css">
    <link rel="stylesheet" href="src/css/dashboard.css">
    <link rel="stylesheet" href="src/css/products.css">
    <link rel="stylesheet" href="src/css/fontawesome/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-logo">
                <img src="assets/icons/logo.svg" alt="AI UMKM Logo" class="sidebar-logo-img">
            </h1>
            <button class="sidebar-close" id="sidebar-close"><i class="fas fa-times"></i></button>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="sidebar-link">
                <span class="sidebar-icon"><i class="fas fa-chart-bar"></i></span>
                <span class="sidebar-text">Dashboard</span>
            </a>
            <a href="products.html" class="sidebar-link active">
                <span class="sidebar-icon"><i class="fas fa-box"></i></span>
                <span class="sidebar-text">Produk</span>
            </a>
            <a href="ideas.html" class="sidebar-link">
                <span class="sidebar-icon"><i class="fas fa-lightbulb"></i></span>
                <span class="sidebar-text">Ide Konten AI</span>
            </a>
            <a href="caption.html" class="sidebar-link">
                <span class="sidebar-icon"><i class="fas fa-pen-fancy"></i></span>
                <span class="sidebar-text">Caption AI</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-details">
                    <p class="user-name" id="user-name">Demo User</p>
                    <p class="user-role">UMKM Owner</p>
                </div>
            </div>
            <button class="btn-logout"  id="btn-logout">Logout</button>
        </div>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="main-wrapper">
        
        <header class="top-header">
            <button class="sidebar-toggle" id="sidebar-toggle"><i class="fas fa-bars"></i></button>
            <h2 class="page-title"><i class="fas fa-box"></i> Kelola Produk</h2>
        </header>

        <main class="dashboard-content" id="app">
            
            <section class="products-section">
                <div class="section-header">
                    <h1 class="page-title"><i class="fas fa-box"></i> Kelola Produk</h1>
                    <p class="page-description">Tambah, edit, dan kelola produk UMKM Anda untuk promosi AI</p>
                </div>

                <div class="action-bar">
                    <button class="btn btn-primary" id="add-product-btn" disabled>
                        <i class="fas fa-spinner fa-spin"></i> Memuat...
                    </button>
                </div>

                <div class="form-container hidden" id="product-form-container">
                    <div class="form-card">
                        <div class="form-header">
                            <h3 id="form-title">Tambah Produk Baru</h3>
                            <button class="btn-close" id="close-form"><i class="fas fa-times"></i></button>
                        </div>

                        <form id="product-form">
                            <div class="form-group">
                                <label for="product-name">Nama Produk *</label>
                                <input type="text" id="product-name" class="form-input" required placeholder="Contoh: Kopi Arabica Premium">
                                <small class="form-hint">Nama produk yang menarik dan mudah diingat</small>
                            </div>

                            <div class="form-group">
                                <label for="product-price">Harga *</label>
                                <input type="number" id="product-price" class="form-input" required placeholder="25000" min="0">
                                <small class="form-hint">Harga dalam Rupiah (tanpa titik atau koma)</small>
                            </div>

                            <div class="form-group">
                                <label for="product-category">Kategori *</label>
                                <select id="product-category" class="form-select" required>
                                    <option value="">Pilih Kategori</option>
                                    <option value="makanan">Makanan</option>
                                    <option value="minuman">Minuman</option>
                                    <option value="fashion">Fashion</option>
                                    <option value="kerajinan">Kerajinan</option>
                                    <option value="jasa">Jasa</option>
                                    <option value="elektronik">Elektronik</option>
                                    <option value="kesehatan">Kesehatan & Kecantikan</option>
                                    <option value="lainnya">Lainnya</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="product-description">Deskripsi Produk</label>
                                <textarea id="product-description" class="form-textarea" placeholder="Ceritakan detail produk Anda: bahan, keunggulan, cara pembuatan, dll."></textarea>
                                <small class="form-hint">Deskripsi akan membantu AI membuat konten yang lebih akurat</small>
                            </div>

                            <div class="form-group">
                                <label for="product-image">Gambar Produk (Opsional)</label>
                                <div class="image-input-switcher" role="tablist" aria-label="Pilih sumber gambar">
                                    <button type="button" class="switch-btn active" data-target="url">Pakai URL</button>
                                    <button type="button" class="switch-btn" data-target="upload">Upload File</button>
                                </div>

                                <div class="image-input-panel" id="image-url-panel">
                                    <input type="url" id="product-image" class="form-input" placeholder="https://example.com/gambar-produk.jpg" aria-label="URL gambar produk">
                                    <small class="form-hint">Tempel tautan gambar produk untuk ditampilkan di kartu produk</small>
                                </div>

                                <div class="image-input-panel hidden" id="image-upload-panel">
                                    <input type="file" id="product-image-file" class="form-input" accept="image/*" aria-label="Upload gambar produk">
                                    <small class="form-hint">Unggah file JPG/PNG maksimal 1MB</small>
                                    <div class="image-preview" id="image-preview-box">
                                        <div class="image-preview-placeholder" id="image-preview-placeholder">Pratinjau akan muncul di sini</div>
                                        <img src="" alt="Pratinjau gambar produk" id="image-preview" class="hidden">
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-form">Batal</button>
                                <button type="submit" class="btn btn-primary" id="save-product">
                                    <span id="save-text">Simpan Produk</span>
                                    <div class="btn-spinner hidden" id="save-spinner"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="products-container">
                    <h3 class="section-subtitle" id="products-title">Produk Anda</h3>
                    
                    <div class="loading-state" id="loading-state">
                        <div class="loading-container">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                            <div class="loading-content">
                                <h3>Memuat Produk...</h3>
                                <p>Sedang mengambil data produk dari database</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="empty-state hidden" id="empty-state">
                        <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                        <h3>Belum Ada Produk</h3>
                        <p>Tambahkan produk pertama Anda untuk mulai membuat konten promosi dengan AI</p>
                        <button class="btn btn-primary" onclick="document.getElementById('add-product-btn').click()">
                            <i class="fas fa-plus"></i> Tambah Produk Pertama
                        </button>
                    </div>

                    <div class="products-grid hidden" id="products-grid">
                    </div>
                </div>

            </section>

        </main>
    </div>

    <div class="promo-popup-overlay hidden" id="promo-popup-overlay">
        <div class="promo-popup">
            <div class="promo-popup-header">
                <h3>Pilih Jenis Promosi AI</h3>
                <button class="promo-popup-close" id="promo-popup-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="promo-popup-content">
                <p class="promo-popup-subtitle">Produk <strong id="selected-product-name"></strong> siap dipromosikan!</p>
                <p class="promo-popup-description">Pilih jenis konten promosi yang ingin Anda buat:</p>
                
                <div class="promo-options">
                    <button class="promo-option-card" id="promo-ideas-btn">
                        <div class="promo-option-header">
                            <div class="promo-option-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h4>Ide Konten</h4>
                        </div>
                        <p>Dapatkan ide konten kreatif untuk promosi produk Anda</p>
                    </button>
                    
                    <button class="promo-option-card" id="promo-caption-btn">
                        <div class="promo-option-header">
                            <div class="promo-option-icon">
                                <i class="fas fa-pen-fancy"></i>
                            </div>
                            <h4>Caption AI</h4>
                        </div>
                        <p>Buat caption menarik siap posting untuk produk Anda</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden">
        <p id="toast-message">Pesan berhasil disalin!</p>
    </div>

    <script src="src/js/utils.js"></script>
    <script src="src/js/auth.js"></script>
    <script src="src/js/db-products.js"></script>
    <script src="src/js/upload-image.js"></script>
    <script src="src/js/ai-products.js"></script>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const isAuth = await requireAuth();
            
            if (!isAuth) {
                return;
            }
            
            const { success, user } = await Auth.getCurrentUser();
            if (success && user) {
                const userNameEl = document.getElementById('user-name');
                if (userNameEl) {
                    userNameEl.textContent = user.user_metadata?.full_name || user.email;
                }
            }
            
            const logoutBtn = document.getElementById('btn-logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    const result = await Auth.logout();
                    
                    if (result.success) {
                        window.location.href = 'login.html';
                    } else {
                        alert('Gagal logout: ' + result.error);
                    }
                });
            }
            
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarClose = document.getElementById('sidebar-close');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            sidebarToggle.addEventListener('click', toggleSidebar);
            
            sidebarClose.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            initializeDashboard();
        });
    

        document.addEventListener('DOMContentLoaded', async function() {
            const isAuth = await requireAuth();
            if (!isAuth) {
                return;
            }
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarClose = document.getElementById('sidebar-close');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const addProductBtn = document.getElementById('add-product-btn');
            const productForm = document.getElementById('product-form');
            const closeFormBtn = document.getElementById('close-form');
            const cancelFormBtn = document.getElementById('cancel-form');

            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarClose.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            addProductBtn.addEventListener('click', function() {
                showAddProductForm();
            });
            
            productForm.addEventListener('submit', function(e) {
                handleSubmitProduct(e);
            });
            
            closeFormBtn.addEventListener('click', function() {
                closeProductForm();
            });
            
            cancelFormBtn.addEventListener('click', function() {
                closeProductForm();
            });

            if (typeof initializeProductsPage === 'function') {
                initializeProductsPage();
            }
            
            const promoPopupClose = document.getElementById('promo-popup-close');
            const promoPopupOverlay = document.getElementById('promo-popup-overlay');
            const promoIdeasBtn = document.getElementById('promo-ideas-btn');
            const promoCaptionBtn = document.getElementById('promo-caption-btn');
            
            if (promoPopupClose) {
                promoPopupClose.addEventListener('click', function() {
                    closePromoPopup();
                });
            }
            
            if (promoPopupOverlay) {
                promoPopupOverlay.addEventListener('click', function(e) {
                    if (e.target === promoPopupOverlay) {
                        closePromoPopup();
                    }
                });
            }
            
            if (promoIdeasBtn) {
                promoIdeasBtn.addEventListener('click', function() {
                    goToIdeasPage();
                });
            }
            
            if (promoCaptionBtn) {
                promoCaptionBtn.addEventListener('click', function() {
                    goToCaptionPage();
                });
            }
        });
    </script>

</body>
</html>