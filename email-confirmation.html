<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfirmasi Email - AI UMKM</title>
    <meta name="description" content="Konfirmasi email untuk mengaktifkan akun AI UMKM">

    <link rel="icon" type="image/png" href="assets/icons/icon-primary.png">

    <link rel="stylesheet" href="src/css/style.css">
    <link rel="stylesheet" href="src/css/email-confirmation.css">
    <link rel="stylesheet" href="src/css/fontawesome/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <nav class="nav" aria-label="Main navigation">
            <div class="nav-links">
                <div class="nav-content">
                    <a href="index.html" class="nav-link">Beranda</a>
                    <a href="login.html" class="nav-link">Masuk</a>
                </div>
                <div class="header-content">
                    <h1 class="logo">
                        <a href="index.html">
                            <img src="assets/icons/logo.svg" alt="UMKM AI Logo" class="logo-img">
                        </a>
                    </h1>
                </div>
            </div>
        </nav>
    </header>
    <main class="main-content">
        <section class="login-section">
            <div class="features">
                <div class="container">
                    <div class="card">
                        <div class="p-2">
                            <h3>Konfirmasi Email</h3>

                            <div class="status-card">
                                <div id="statusIcon" class="status-icon pending">
                                    <i class="fas fa-hourglass-half" aria-hidden="true"></i>
                                </div>
                                <h4 id="statusTitle">Memverifikasi tautan...</h4>
                                <p id="statusMessage" class="status-message">Kami sedang memproses tautan konfirmasi email kamu.</p>
                                <p id="statusNote" class="status-note">Jika tidak berubah dalam beberapa detik, silakan coba buka ulang tautan dari email.</p>

                                <div class="status-actions">
                                    <button id="loginButton" class="btn btn-primary hidden" type="button">Masuk ke AI UMKM</button>
                                    <a href="index.html" class="btn btn-secondary mt-1">Kembali ke Beranda</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>&copy; 2025 AI UMKM - Platform AI untuk UMKM Indonesia</p>
            <p>Membantu usaha lokal berkembang dengan teknologi kecerdasan buatan</p>
        </footer>
    </main>

    <script src="src/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const statusNote = document.getElementById('statusNote');
            const loginButton = document.getElementById('loginButton');

            function setStatus(type, title, message, note, showLogin) {
                statusTitle.textContent = title;
                statusMessage.textContent = message;
                statusNote.textContent = note;

                statusIcon.classList.remove('success', 'pending', 'error');

                if (type === 'success') {
                    statusIcon.classList.add('success');
                    statusIcon.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
                } else if (type === 'error') {
                    statusIcon.classList.add('error');
                    statusIcon.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i>';
                } else {
                    statusIcon.classList.add('pending');
                    statusIcon.innerHTML = '<i class="fas fa-hourglass-half" aria-hidden="true"></i>';
                }

                if (showLogin) {
                    loginButton.classList.remove('hidden');
                } else {
                    loginButton.classList.add('hidden');
                }
            }

            loginButton.addEventListener('click', function() {
                window.location.href = 'login.html';
            });

            try {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');

                if (code) {
                    setStatus('pending', 'Memverifikasi tautan...', 'Kami sedang mengaktifkan akun kamu.', 'Sebentar ya, proses konfirmasi berjalan.', false);

                    const exchangeResult = await Auth.exchangeCodeForSession(code);

                    if (!exchangeResult.success) {
                        setStatus('error', 'Konfirmasi gagal', 'Kode verifikasi tidak valid atau sudah digunakan.', 'Coba buka ulang tautan dari email atau minta kirim ulang verifikasi.', false);
                        return;
                    }
                }

                // Cek apakah email sudah terverifikasi
                const verification = await Auth.isEmailVerified();

                if (verification.success && verification.verified) {
                    setStatus('success', 'Email berhasil diverifikasi', 'Akun kamu sudah aktif dan siap digunakan.', 'Silakan masuk untuk melanjutkan ke dashboard.', true);
                } else {
                    setStatus('pending', 'Menunggu konfirmasi email', 'Kami belum menerima konfirmasi email.', 'Buka tautan verifikasi yang dikirim ke email, lalu muat ulang halaman ini.', false);
                }
            } catch (error) {
                console.error('Email confirmation error:', error);
                setStatus('error', 'Terjadi kesalahan', 'Kami tidak bisa memproses konfirmasi email.', 'Coba lagi beberapa saat atau minta tautan verifikasi baru.', false);
            }
        });
    </script>
</body>
</html>
