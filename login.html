<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - AI UMKM</title>
    <meta name="description" content="Masuk ke platform AI UMKM untuk mengakses fitur premium">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/icons/icon-primary.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="src/css/style.css">
    <link rel="stylesheet" href="src/css/login.css">
    <link rel="stylesheet" href="src/css/fontawesome/css/all.min.css">
    
    <!-- Font Inter & Poppins dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <nav class="nav" aria-label="Main navigation">
            <div class="nav-links">
                <div class="nav-content">
                    <a href="index.html" class="nav-link">Beranda</a>
                    <a href="register.html" class="nav-link">Daftar</a>
                </div>
                <div class="header-content">
                    <h1 class="logo">
                        <a href="index.html">
                            <img src="assets/icons/logo.svg" alt="UMKM AI Logo" class="logo-img">
                        </a>
                    </h1>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- LOGIN SECTION -->
        <section class="login-section">
            <div class="features">
                <div class="container">
                    <div class="card">
                        <div class="p-2">
                            <h3>Masuk ke AI UMKM</h3>

                            <form id="loginForm" class="auth-form">
                                <div class="form-group">
                                    <label for="loginEmail">Email</label>
                                    <input id="loginEmail" type="email" class="form-input" required placeholder="Masukkan email Anda">
                                </div>
                                
                                <div class="form-group">
                                    <label for="loginPassword">Kata Sandi</label>
                                    <input id="loginPassword" type="password" class="form-input" required placeholder="Masukkan kata sandi">
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-container">
                                        <input id="rememberMe" type="checkbox">
                                        <span class="checkmark"></span>
                                        Ingat saya selama 30 hari
                                    </label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-generate">Masuk</button>
                                
                                <p class="muted" style="text-align: center; margin-top: 1rem;">
                                    Belum punya akun? <a href="register.html" class="link-like">Daftar di sini</a>
                                </p>
                            </form>

                            <div class="text-center mt-2">
                                <a href="index.html" class="btn btn-secondary">Kembali ke Beranda</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- FOOTER -->
        <footer class="footer">
            <p>&copy; 2025 AI UMKM - Platform AI untuk UMKM Indonesia</p>
            <p>Membantu usaha lokal berkembang dengan teknologi kecerdasan buatan</p>
        </footer>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <p id="toast-message">Pesan berhasil disalin!</p>
    </div>

    <!-- JavaScript -->
    <!-- Catatan: Supabase client tidak diperlukan - auth lewat Netlify Functions -->
    <script src="src/js/cookies.js"></script>
    <script src="src/js/utils.js"></script>
    <script src="src/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for auto-login first
            const isAutoLoggedIn = await checkAutoLogin();
            
            // Only check manual authentication if auto-login didn't succeed
            if (!isAutoLoggedIn) {
                // Check if already authenticated, redirect to dashboard
                await redirectIfAuthenticated();
                
                // Load remembered email if exists
                loadRememberedData();
            }
            
            // Handle login form submission
            const loginForm = document.getElementById('loginForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get form values
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const rememberMe = document.getElementById('rememberMe').checked;
                    
                    // Validation
                    if (!email) {
                        showToast('Email harus diisi!');
                        return;
                    }
                    
                    if (!password) {
                        showToast('Kata sandi harus diisi!');
                        return;
                    }
                    
                    // Disable submit button
                    const submitBtn = loginForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Masuk...';
                    
                    // Login with Supabase
                    const result = await Auth.login(email, password, rememberMe);
                    
                    if (result.success) {
                        showToast('Login berhasil! Mengalihkan...');
                        
                        // Store last login time
                        localStorage.setItem('lastLogin', new Date().toISOString());
                        
                        // Redirect to dashboard
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                    } else {
                        // Handle error
                        let errorMessage = 'Login gagal! ';
                        
                        if (result.error.includes('Invalid login credentials')) {
                            errorMessage += 'Email atau kata sandi salah.';
                        } else if (result.error.includes('Email not confirmed')) {
                            errorMessage += 'Silakan konfirmasi email Anda terlebih dahulu.';
                        } else {
                            errorMessage += result.error;
                        }
                        
                        showToast(errorMessage);
                        
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Listen for auth state changes
            Auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session);
                
                if (event === 'SIGNED_IN' && session) {
                    console.log('User signed in:', session.user.email);
                    // Session akan di-handle oleh response login
                } else if (event === 'SIGNED_OUT') {
                    console.log('User signed out');
                    // Clear cookies when signed out
                    if (typeof window.clearAuthSession === 'function') {
                        window.clearAuthSession();
                    }
                }
            });
        });
        
        // Function to check auto-login
        async function checkAutoLogin() {
            try {
                // Initialize auth system and check for valid sessions
                const authState = await Auth.initAuth();
                
                if (authState.authenticated) {
                    showToast('Login otomatis berhasil! Mengalihkan...');
                    
                    // Redirect ke dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                    
                    return true; // Prevent further processing
                }
                
                return false; // Continue normal flow
            } catch (error) {
                console.log('Auto-login check failed:', error);
                return false;
            }
        }
        
        // Function to load remembered data
        function loadRememberedData() {
            if (typeof window.getAuthSession === 'function') {
                const session = window.getAuthSession();
                
                if (session.email && session.rememberMe) {
                    document.getElementById('loginEmail').value = session.email;
                    document.getElementById('rememberMe').checked = true;
                    
                    // Show toast about remembered data
                    showToast('Email tersimpan dari login sebelumnya');
                }
            }
        }
        
        // Toast notification function
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
</body>
</html>